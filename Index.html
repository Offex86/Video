<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deepak's Audio Studio v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Premium Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Syncopate:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        brand: ['Syncopate', 'sans-serif'],
                        display: ['Rajdhani', 'sans-serif'],
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        gold: {
                            100: '#F9F1D0',
                            300: '#D4AF37',
                            400: '#C5A028',
                            500: '#B49121',
                        },
                        studio: {
                            bg: '#050505',
                            card: '#111111',
                            border: '#222222'
                        }
                    },
                    animation: {
                        'shine': 'shine 3s linear infinite',
                    },
                    keyframes: {
                        shine: {
                            '0%': { backgroundPosition: '0% 50%' },
                            '100%': { backgroundPosition: '100% 50%' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050505;
            color: #e0e0e0;
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(212, 175, 55, 0.1) 0%, transparent 40%),
                linear-gradient(0deg, #050505 0%, #0a0a0a 100%);
        }
        
        .glass-panel {
            background: rgba(17, 17, 17, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .text-gold-gradient {
            background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 200% auto;
            animation: shine 5s linear infinite;
        }

        /* Audio Player Styling */
        audio {
            width: 100%;
            height: 40px;
            border-radius: 8px;
            filter: sepia(100%) hue-rotate(5deg) saturate(300%) contrast(1.2);
        }
        
        /* Visualizer Canvas */
        canvas {
            width: 100%;
            height: 80px;
            border-bottom: 1px solid #333;
            background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(212, 175, 55, 0.05) 100%);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Branding -->
    <div class="mb-6 text-center animate-fade-in">
        <p class="text-xs font-mono text-gray-500 tracking-[0.3em] mb-2">AUDIO ENGINEERING TOOL</p>
        <h1 class="text-4xl md:text-5xl font-brand font-bold tracking-tighter text-gold-gradient drop-shadow-2xl">
            MADE BY DEEPAK
        </h1>
        <div class="h-1 w-20 bg-gradient-to-r from-transparent via-gold-400 to-transparent mx-auto mt-4 rounded-full"></div>
    </div>

    <!-- Main Container -->
    <div class="w-full max-w-3xl glass-panel rounded-3xl overflow-hidden relative border border-gray-800">
        
        <!-- Header -->
        <div class="bg-studio-card/80 p-5 border-b border-studio-border flex justify-between items-center z-10 relative">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-gold-400 to-yellow-700 flex items-center justify-center text-black font-bold shadow-lg shadow-gold-400/20">
                    <i class="fas fa-wave-square"></i>
                </div>
                <div>
                    <h2 class="font-display font-bold text-xl text-white tracking-wide">SILENCE <span class="text-gold-300">REMOVER</span></h2>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="location.reload()" class="w-8 h-8 rounded-full bg-gray-800 hover:bg-red-900/50 hover:text-red-400 text-gray-400 border border-gray-700 transition-all flex items-center justify-center" title="Reset">
                    <i class="fas fa-redo-alt text-xs"></i>
                </button>
            </div>
        </div>

        <!-- 1. Upload Screen -->
        <div id="uploadBox" class="p-10 relative group">
            <input type="file" id="audioInput" accept="audio/*, .mp3, .wav, .ogg" 
                   class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-50"
                   onchange="handleFileUpload(this)">

            <div class="border-2 border-dashed border-gray-700 rounded-2xl p-10 text-center group-hover:border-gold-400 transition-colors bg-studio-card/50">
                <div class="w-16 h-16 bg-black rounded-full flex items-center justify-center mx-auto mb-4 shadow-xl border border-gray-800 group-hover:border-gold-400/50">
                    <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 group-hover:text-gold-300"></i>
                </div>
                <h3 class="text-lg font-bold text-white font-display tracking-wide" id="fileName">TAP TO UPLOAD AUDIO</h3>
                <p class="text-xs text-gray-500 mt-2 font-mono">MP3, WAV, OGG</p>
            </div>
        </div>

        <!-- 2. Controls & Preview Screen -->
        <div id="controlsArea" class="hidden p-6 space-y-6">
            
            <!-- Original Audio Preview -->
            <div class="bg-studio-card border border-studio-border rounded-xl p-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] font-bold text-gold-500 uppercase tracking-widest">Original Audio Preview</span>
                    <span class="text-[10px] font-mono text-gray-500" id="origDur">00:00</span>
                </div>
                
                <!-- Visualizer Canvas -->
                <canvas id="canvasOriginal" class="rounded-t-lg"></canvas>
                
                <!-- Player -->
                <audio id="playerOriginal" controls onplay="startVisualizer('playerOriginal', 'canvasOriginal')"></audio>
            </div>

            <!-- Settings -->
            <div class="flex flex-col md:flex-row gap-6 items-end">
                <div class="flex-1 w-full">
                    <label class="block text-xs font-bold text-gray-400 mb-2">SILENCE THRESHOLD (SEC)</label>
                    <div class="flex items-center gap-2">
                        <button onclick="adjustValue(-0.1)" class="w-10 h-10 bg-gray-800 rounded text-white hover:bg-gray-700">-</button>
                        <input type="number" id="silenceDuration" value="0.5" step="0.1" min="0.1" class="flex-1 bg-black border border-gray-700 text-gold-400 text-center p-2 h-10 rounded font-bold text-xl outline-none">
                        <button onclick="adjustValue(0.1)" class="w-10 h-10 bg-gray-800 rounded text-white hover:bg-gray-700">+</button>
                    </div>
                </div>
                
                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="location.reload()" class="bg-gray-800 text-gray-400 px-4 py-3 rounded-lg font-bold hover:bg-red-900/30 hover:text-red-400 border border-gray-700">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button onclick="processAudio()" id="processBtn" class="flex-1 bg-gradient-to-r from-gold-400 to-yellow-600 hover:from-gold-300 hover:to-yellow-500 text-black font-bold py-3 px-8 rounded-lg shadow-lg shadow-gold-500/20 transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-bolt"></i> PROCESS
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loader" class="hidden py-12 text-center">
            <div class="w-12 h-12 border-4 border-gray-800 border-t-gold-400 rounded-full animate-spin mx-auto"></div>
            <p class="text-gold-300 mt-4 font-mono text-xs tracking-widest animate-pulse">DEEPAK AI IS THINKING...</p>
        </div>

        <!-- 3. Result Screen -->
        <div id="resultArea" class="hidden p-6 space-y-6">
            
            <div class="bg-studio-card border border-gold-500/30 rounded-xl p-4 relative overflow-hidden">
                <div class="absolute inset-0 bg-gold-400/5 pointer-events-none"></div>
                <div class="flex justify-between items-center mb-2 relative z-10">
                    <span class="text-[10px] font-bold text-gold-300 uppercase tracking-widest">Final Processed Audio</span>
                    <span class="text-[10px] font-mono text-gold-400 font-bold" id="newDur">00:00</span>
                </div>
                
                <!-- Visualizer Canvas -->
                <canvas id="canvasProcessed" class="rounded-t-lg"></canvas>
                
                <!-- Player -->
                <audio id="playerProcessed" controls onplay="startVisualizer('playerProcessed', 'canvasProcessed')"></audio>
            </div>

            <a id="downloadLink" class="block w-full text-center bg-white hover:bg-gray-200 text-black font-bold text-sm py-4 rounded-xl transition-all shadow-xl tracking-widest cursor-pointer">
                <i class="fas fa-download mr-2"></i> DOWNLOAD WAV FILE
            </a>
            
            <button onclick="location.reload()" class="block w-full text-center text-xs text-gray-500 hover:text-white mt-2">
                <i class="fas fa-undo mr-1"></i> Start Over
            </button>
        </div>

    </div>

    <!-- Footer -->
    <div class="mt-6 text-center opacity-40">
        <p class="text-[10px] font-mono">ENGINEERED BY DEEPAK &bull; v3.0</p>
    </div>

    <script>
        let audioContext;
        let originalBuffer = null;
        let fileNameStr = "audio";
        
        // Visualizer Vars
        let visContext = null;
        let activeSource = null;
        let activeAnalyser = null;
        let animId = null;

        function adjustValue(delta) {
            const input = document.getElementById('silenceDuration');
            let val = parseFloat(input.value) + delta;
            if (val < 0.1) val = 0.1;
            input.value = val.toFixed(1);
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            fileNameStr = file.name.split('.')[0] + "_Deepak_Cut";
            
            // UI Switch
            document.getElementById('uploadBox').classList.add('hidden');
            document.getElementById('controlsArea').classList.remove('hidden');

            // 1. Setup Preview Player directly from file blob (Instant Playback)
            const fileURL = URL.createObjectURL(file);
            const playerOrig = document.getElementById('playerOriginal');
            playerOrig.src = fileURL;

            // 2. Decode for processing
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch(e) { alert("Browser not supported"); return; }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                audioContext.decodeAudioData(e.target.result, function(buffer) {
                    originalBuffer = buffer;
                    document.getElementById('origDur').innerText = formatTime(buffer.duration);
                }, function(e) {
                    alert("Error decoding file.");
                });
            };
            reader.readAsArrayBuffer(file);
        }

        // --- Visualizer Logic ---
        function startVisualizer(playerId, canvasId) {
            const audioElem = document.getElementById(playerId);
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');

            // Initialize Audio Context for Visualizer separately to avoid conflicts
            if (!visContext) {
                visContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            // Create source only once per element
            if (!audioElem._source) {
                audioElem._source = visContext.createMediaElementSource(audioElem);
                audioElem._analyser = visContext.createAnalyser();
                audioElem._source.connect(audioElem._analyser);
                audioElem._analyser.connect(visContext.destination);
                audioElem._analyser.fftSize = 256;
            }

            const analyser = audioElem._analyser;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            if (visContext.state === 'suspended') {
                visContext.resume();
            }

            function renderFrame() {
                if (audioElem.paused) return; // Stop drawing if paused
                
                animId = requestAnimationFrame(renderFrame);
                analyser.getByteFrequencyData(dataArray);

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const barWidth = (canvas.width / bufferLength) * 2.5;
                let barHeight;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    barHeight = dataArray[i] / 2; // Scale height
                    
                    // Gold Gradient Bar
                    const gradient = ctx.createLinearGradient(0, canvas.height, 0, 0);
                    gradient.addColorStop(0, '#B49121');
                    gradient.addColorStop(1, '#F9F1D0');

                    ctx.fillStyle = gradient;
                    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

                    x += barWidth + 1;
                }
            }
            
            // Start Animation Loop
            renderFrame();
        }

        // --- Processing Logic ---
        function processAudio() {
            if (!originalBuffer) return;

            document.getElementById('controlsArea').classList.add('hidden');
            document.getElementById('loader').classList.remove('hidden');

            // Pause preview if playing
            document.getElementById('playerOriginal').pause();

            setTimeout(() => {
                removeSilence();
            }, 100);
        }

        function removeSilence() {
            const thresholdInput = document.getElementById('silenceDuration').value;
            const minSilenceDuration = parseFloat(thresholdInput);
            const amplitudeThreshold = 0.01; 

            const rawData = originalBuffer.getChannelData(0);
            const sampleRate = originalBuffer.sampleRate;
            const minSilenceSamples = minSilenceDuration * sampleRate;
            
            let keepRegions = [];
            let currentRegionStart = 0;
            let inSilence = false;
            let currentSilenceStart = 0;

            for (let i = 0; i < rawData.length; i++) {
                const amplitude = Math.abs(rawData[i]);

                if (amplitude < amplitudeThreshold) {
                    if (!inSilence) {
                        inSilence = true;
                        currentSilenceStart = i;
                    }
                } else {
                    if (inSilence) {
                        const silenceDuration = i - currentSilenceStart;
                        if (silenceDuration > minSilenceSamples) {
                            keepRegions.push([currentRegionStart, currentSilenceStart]);
                            currentRegionStart = i;
                        }
                        inSilence = false;
                    }
                }
            }
            keepRegions.push([currentRegionStart, rawData.length]);

            let newLength = 0;
            keepRegions.forEach(r => newLength += (r[1] - r[0]));

            if (newLength === 0 || newLength === rawData.length) {
                alert("No silence found or file empty. Adjust seconds.");
                location.reload();
                return;
            }

            const newBuffer = audioContext.createBuffer(
                originalBuffer.numberOfChannels,
                newLength,
                sampleRate
            );

            for (let channel = 0; channel < originalBuffer.numberOfChannels; channel++) {
                const oldData = originalBuffer.getChannelData(channel);
                const newData = newBuffer.getChannelData(channel);
                let pointer = 0;

                keepRegions.forEach(r => {
                    const chunk = oldData.slice(r[0], r[1]);
                    newData.set(chunk, pointer);
                    pointer += chunk.length;
                });
            }

            finishProcessing(newBuffer);
        }

        function finishProcessing(newBuffer) {
            // Convert to WAV
            const wavData = bufferToWave(newBuffer, newBuffer.length);
            const blob = new Blob([wavData], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);

            document.getElementById('loader').classList.add('hidden');
            document.getElementById('resultArea').classList.remove('hidden');

            document.getElementById('newDur').innerText = formatTime(newBuffer.duration);
            
            const player = document.getElementById('playerProcessed');
            player.src = url;

            const dlLink = document.getElementById('downloadLink');
            dlLink.href = url;
            dlLink.download = fileNameStr + ".wav";
        }

        // Utils
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s < 10 ? '0' + s : s}`;
        }

        function bufferToWave(abuffer, len) {
            let numOfChan = abuffer.numberOfChannels,
                length = len * numOfChan * 2 + 44,
                buffer = new ArrayBuffer(length),
                view = new DataView(buffer),
                channels = [], i, sample,
                offset = 0, pos = 0;

            setUint32(0x46464952); setUint32(length - 8); setUint32(0x45564157);
            setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan);
            setUint32(abuffer.sampleRate); setUint32(abuffer.sampleRate * 2 * numOfChan);
            setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164);
            setUint32(length - pos - 4);

            for(i = 0; i < abuffer.numberOfChannels; i++) channels.push(abuffer.getChannelData(i));

            while(pos < len) {
                for(i = 0; i < numOfChan; i++) {
                    sample = Math.max(-1, Math.min(1, channels[i][pos]));
                    sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767)|0;
                    view.setInt16(44 + offset, sample, true); offset += 2;
                }
                pos++;
            }
            return buffer;

            function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
            function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }
        }
    </script>
</body>
